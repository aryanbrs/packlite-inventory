<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Plant Production Tracker</title>
    <style>
        :root {
            --primary-color: #005A9C;
            --secondary-color: #00A3E0;
            --background-color: #f4f7f9;
            --card-background: #ffffff;
            --text-color: #333;
            --text-light: #666;
            --success-color: #28a745;
            --warning-color: #ffc107;
            --danger-color: #dc3545;
            --border-color: #e0e0e0;
            --font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        }

        /* Reset and Base Styles */
        * { box-sizing: border-box; margin: 0; padding: 0; }
        html, body {
            font-family: var(--font-family);
            background-color: var(--background-color);
            color: var(--text-color);
            overscroll-behavior-y: contain;
        }
        #app { display: flex; flex-direction: column; height: 100vh; }

        /* Header */
        header {
            background-color: var(--primary-color);
            color: white;
            padding: 15px;
            text-align: center;
            font-size: 1.2rem;
            font-weight: 600;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            position: sticky; top: 0; z-index: 100;
        }
        
        /* Main Content & Views */
        main {
            flex-grow: 1;
            overflow-y: auto;
            padding: 15px;
        }
        .view { display: none; }
        .view.active { display: block; animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Cards */
        .card {
            background: var(--card-background);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            border-left: 5px solid var(--primary-color);
        }
        .card-header {
            font-weight: 600;
            font-size: 1.1rem;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .card-body p {
            margin-bottom: 8px;
            color: var(--text-light);
            font-size: 0.95rem;
        }
        .card-body p strong { color: var(--text-color); }

        /* Buttons */
        .btn {
            display: inline-block;
            padding: 12px 20px;
            border-radius: 6px;
            border: none;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            text-align: center;
            transition: background-color 0.2s;
        }
        .btn-primary { background-color: var(--primary-color); color: white; }
        .btn-primary:hover { background-color: #00487a; }
        .btn-secondary { background-color: var(--secondary-color); color: white; }
        .btn-success { background-color: var(--success-color); color: white; }
        .btn-danger { background-color: var(--danger-color); color: white; }
        .btn-block { display: block; width: 100%; margin-top: 10px; }
        .btn-small { padding: 6px 12px; font-size: 0.8rem; }
        .fab {
            position: fixed;
            bottom: 80px;
            right: 20px;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background-color: var(--secondary-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            border: none;
            cursor: pointer;
            z-index: 1000;
        }

        /* Forms */
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 600; font-size: 0.9rem; }
        .form-control {
            width: 100%;
            padding: 12px;
            font-size: 1rem;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background-color: #fff;
        }
        textarea.form-control { resize: vertical; min-height: 80px; }
        .autocomplete-container { position: relative; }
        .autocomplete-list {
            position: absolute;
            top: 100%; left: 0; right: 0;
            background: white;
            border: 1px solid var(--border-color);
            border-radius: 0 0 6px 6px;
            max-height: 150px;
            overflow-y: auto;
            z-index: 100;
        }
        .autocomplete-item {
            padding: 10px;
            cursor: pointer;
        }
        .autocomplete-item:hover, .autocomplete-item.add-new {
            background-color: var(--background-color);
        }
        .autocomplete-item.add-new { color: var(--primary-color); font-weight: 600; }
        .machine-checkbox-group label {
            display: flex;
            align-items: center;
            padding: 10px;
            background-color: var(--background-color);
            border-radius: 6px;
            margin-bottom: 8px;
        }
        .machine-checkbox-group input { margin-right: 10px; width: 20px; height: 20px; }

        /* Navigation */
        #bottom-nav {
            display: flex;
            justify-content: space-around;
            background: var(--card-background);
            padding: 10px 0;
            box-shadow: 0 -2px 5px rgba(0,0,0,0.1);
            position: sticky; bottom: 0; z-index: 100;
        }
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            color: var(--text-light);
            padding: 5px 10px;
            border-radius: 8px;
            transition: background-color 0.2s, color 0.2s;
        }
        .nav-item.active { color: var(--primary-color); }
        .nav-item svg { width: 24px; height: 24px; margin-bottom: 4px; }
        .nav-item span { font-size: 0.75rem; font-weight: 500; }
        
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1001;
            left: 0; top: 0;
            width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
        }
        .modal.active { display: flex; }
        .modal-content {
            background-color: var(--background-color);
            margin: 15px;
            padding: 20px;
            border-radius: 12px;
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
        }
        .modal-header {
            font-size: 1.2rem;
            font-weight: 600;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .modal-body { overflow-y: auto; }
        .modal-close { font-size: 1.8rem; line-height: 1; cursor: pointer; border: none; background: none; }

        /* Progress Bar */
        .progress-bar {
            width: 100%;
            height: 20px;
            background-color: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        .progress-bar-fill {
            height: 100%;
            background-color: var(--success-color);
            text-align: center;
            color: white;
            font-size: 0.8rem;
            line-height: 20px;
            font-weight: 600;
            transition: width 0.3s ease-in-out;
        }
        
        /* Utility */
        .text-center { text-align: center; }
        .empty-state {
            text-align: center;
            color: var(--text-light);
            padding: 40px 20px;
        }
        .badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        .badge-success { background-color: var(--success-color); color: white; }
        .badge-warning { background-color: var(--warning-color); color: #333; }
        .note-btn { background: none; border: none; cursor: pointer; color: var(--primary-color); font-size: 1.5rem; }

        /* Machine Status */
        .machine-status-list li {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid var(--border-color);
        }
         .machine-status-list li:last-child { border-bottom: none; }
    </style>
</head>
<body>
    <!-- SVG Icon Definitions -->
    <svg style="display:none;">
        <symbol id="icon-dashboard" viewBox="0 0 24 24"><path fill="currentColor" d="M13 3h-2v10h2V3zm4.83 2.17l-1.42 1.42A6.92 6.92 0 0 1 19 12c0 3.87-3.13 7-7 7s-7-3.13-7-7c0-1.7.6-3.24 1.58-4.42L5.17 5.17A8.932 8.932 0 0 0 3 12a9 9 0 0 0 9 9 9 9 0 0 0 9-9c0-2.39-1.01-4.54-2.17-6.83z"/></symbol>
        <symbol id="icon-production" viewBox="0 0 24 24"><path fill="currentColor" d="M20.5 11H19V7c0-1.1-.9-2-2-2h-4V3.5C13 2.12 11.88 1 10.5 1S8 2.12 8 3.5V5H4c-1.1 0-1.99.9-1.99 2v3.8H3.5c1.49 0 2.7 1.21 2.7 2.7s-1.21 2.7-2.7 2.7H2v3.8c0 1.1.9 2 2 2h4v1.5c0 1.38 1.12 2.5 2.5 2.5s2.5-1.12 2.5-2.5V19h4c1.1 0 2-.9 2-2v-4h1.5c1.38 0 2.5-1.12 2.5-2.5S21.88 11 20.5 11z"/></symbol>
        <symbol id="icon-inventory" viewBox="0 0 24 24"><path fill="currentColor" d="M21 16.5c0 .83-.67 1.5-1.5 1.5s-1.5-.67-1.5-1.5V13H6v3.5c0 .83-.67 1.5-1.5 1.5S3 17.33 3 16.5V7c0-1.1.9-2 2-2h14c1.1 0 2 .9 2 2v9.5zM11 9H9v2h2V9zm4 0h-2v2h2V9z"/></symbol>
        <symbol id="icon-dispatch" viewBox="0 0 24 24"><path fill="currentColor" d="M20 8h-3V4H3c-1.1 0-2 .9-2 2v11h2c0 1.66 1.34 3 3 3s3-1.34 3-3h6c0 1.66 1.34 3 3 3s3-1.34 3-3h2v-5l-3-4zM6 18.5c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zm13.5-9l1.96 2.5H17V9.5h3.5zM18 18.5c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5z"/></symbol>
        <symbol id="icon-settings" viewBox="0 0 24 24"><path fill="currentColor" d="M19.43 12.98c.04-.32.07-.64.07-.98s-.03-.66-.07-.98l2.11-1.65c.19-.15.24-.42.12-.64l-2-3.46c-.12-.22-.39-.3-.61-.22l-2.49 1c-.52-.4-1.08-.73-1.69-.98l-.38-2.65C14.46 2.18 14.25 2 14 2h-4c-.25 0-.46.18-.49.42l-.38 2.65c-.61.25-1.17.59-1.69.98l-2.49-1c-.23-.09-.49 0-.61.22l-2 3.46c-.13.22-.07.49.12.64l2.11 1.65c-.04.32-.07.65-.07.98s.03.66.07.98l-2.11 1.65c-.19.15-.24.42-.12.64l2 3.46c.12.22.39.3.61.22l2.49-1c.52.4 1.08.73 1.69.98l.38 2.65c.03.24.24.42.49.42h4c.25 0 .46-.18.49-.42l.38-2.65c.61-.25 1.17-.59 1.69-.98l2.49 1c.23.09.49 0 .61-.22l2-3.46c.12-.22.07-.49-.12-.64l-2.11-1.65zM12 15.5c-1.93 0-3.5-1.57-3.5-3.5s1.57-3.5 3.5-3.5 3.5 1.57 3.5 3.5-1.57 3.5-3.5 3.5z"/></symbol>
    </svg>

    <div id="app">
        <header id="header-title">Dashboard</header>
        
        <main id="main-content">
            <!-- Dashboard View -->
            <div id="view-dashboard" class="view active">
                <div id="dashboard-machine-list"></div>
            </div>

            <!-- Production View -->
            <div id="view-production" class="view">
                <div id="production-list"></div>
                <button class="fab" onclick="showModal('modal-add-product')">+</button>
            </div>

            <!-- Inventory View -->
            <div id="view-inventory" class="view">
                <div id="inventory-list"></div>
            </div>

            <!-- Dispatch View -->
            <div id="view-dispatch" class="view">
                <button class="btn btn-primary btn-block" onclick="showModal('modal-add-dispatch')">Create New Dispatch</button>
                <h3 style="margin-top:20px; margin-bottom:10px;">Today's Dispatches</h3>
                <div id="dispatch-log-list"></div>
            </div>

            <!-- Settings View -->
            <div id="view-settings" class="view">
                <div class="card">
                    <div class="card-header">Data Management</div>
                    <div class="card-body">
                        <p>Export all your current data to a JSON file as a backup.</p>
                        <button class="btn btn-primary btn-block" onclick="App.exportData()">Export Data Backup</button>
                        <hr style="margin: 20px 0; border: 0; border-top: 1px solid var(--border-color);">
                        <p>Import data from a backup file. This will overwrite all current data.</p>
                        <input type="file" id="import-file-input" style="display:none;" onchange="App.importData(event)">
                        <button class="btn btn-danger btn-block" onclick="document.getElementById('import-file-input').click()">Import from Backup</button>
                    </div>
                </div>
            </div>
        </main>

        <!-- Modals -->
        <!-- Add/Edit Product Modal -->
        <div id="modal-add-product" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <span>Add New Product to Production</span>
                    <button class="modal-close" onclick="hideModal('modal-add-product')">&times;</button>
                </div>
                <div class="modal-body">
                    <form id="form-add-product" onsubmit="App.handleProductForm(event)">
                        <div class="form-group autocomplete-container">
                            <label for="product-company">Company</label>
                            <input type="text" id="product-company" class="form-control" placeholder="Type to search or add new" required autocomplete="off">
                            <div class="autocomplete-list" id="company-autocomplete-list"></div>
                        </div>
                        <div class="form-group autocomplete-container">
                            <label for="product-name">Product Name</label>
                            <input type="text" id="product-name" class="form-control" placeholder="e.g., Prime Box" required autocomplete="off">
                             <div class="autocomplete-list" id="product-autocomplete-list"></div>
                        </div>
                        <div class="form-group">
                            <label for="product-dimensions">Dimensions (e.g., 10x8x4)</label>
                            <input type="text" id="product-dimensions" class="form-control" placeholder="Length x Width x Height">
                        </div>
                        <div class="form-group">
                            <label for="product-qty">Total Quantity for this Run</label>
                            <input type="number" id="product-qty" class="form-control" placeholder="e.g., 5000" required min="1">
                        </div>
                        <div class="form-group">
                            <label>Machines Involved</label>
                            <div id="product-machines" class="machine-checkbox-group"></div>
                        </div>
                        <button type="submit" class="btn btn-primary btn-block">Add to Production Line</button>
                    </form>
                </div>
            </div>
        </div>

        <!-- Update Progress Modal -->
        <div id="modal-update-progress" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <span id="progress-modal-title">Update Progress</span>
                    <button class="modal-close" onclick="hideModal('modal-update-progress')">&times;</button>
                </div>
                <div class="modal-body">
                    <form id="form-update-progress" onsubmit="App.handleProgressUpdate(event)">
                        <input type="hidden" id="progress-production-id">
                        <input type="hidden" id="progress-machine-name">
                        <p>Machine: <strong id="progress-machine-label"></strong></p>
                        <p>Total for run: <strong id="progress-total-qty-label"></strong></p>
                        <div class="form-group">
                            <label for="progress-qty-done">Quantity Completed in this step</label>
                            <input type="number" id="progress-qty-done" class="form-control" required min="0">
                        </div>
                        <button type="submit" class="btn btn-primary btn-block">Update Progress</button>
                    </form>
                </div>
            </div>
        </div>
        
        <!-- Add Note Modal -->
        <div id="modal-add-note" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <span>Add Note</span>
                    <button class="modal-close" onclick="hideModal('modal-add-note')">&times;</button>
                </div>
                <div class="modal-body">
                    <form id="form-add-note" onsubmit="App.handleAddNote(event)">
                        <input type="hidden" id="note-production-id">
                        <div class="form-group">
                            <label for="note-text">Note</label>
                            <textarea id="note-text" class="form-control" required></textarea>
                        </div>
                        <button type="submit" class="btn btn-primary btn-block">Save Note</button>
                    </form>
                </div>
            </div>
        </div>

        <!-- Add Dispatch Modal -->
        <div id="modal-add-dispatch" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <span>Create New Dispatch</span>
                    <button class="modal-close" onclick="hideModal('modal-add-dispatch')">&times;</button>
                </div>
                <div class="modal-body">
                    <form id="form-add-dispatch" onsubmit="App.handleDispatch(event)">
                        <div class="form-group">
                            <label for="dispatch-party-name">Party Name / Recipient</label>
                            <input type="text" id="dispatch-party-name" class="form-control" required placeholder="e.g., Amazon Warehouse">
                        </div>
                        <hr style="margin: 20px 0; border: 0; border-top: 1px solid var(--border-color);">
                        <h4>Select Products from Inventory</h4>
                        <div id="dispatch-inventory-list"></div>
                        <button type="submit" class="btn btn-success btn-block" style="margin-top: 20px;">Complete and Log Dispatch</button>
                    </form>
                </div>
            </div>
        </div>
        

        <nav id="bottom-nav">
            <div class="nav-item active" onclick="App.showView('dashboard')">
                <svg><use href="#icon-dashboard"/></svg>
                <span>Dashboard</span>
            </div>
            <div class="nav-item" onclick="App.showView('production')">
                <svg><use href="#icon-production"/></svg>
                <span>Production</span>
            </div>
            <div class="nav-item" onclick="App.showView('inventory')">
                <svg><use href="#icon-inventory"/></svg>
                <span>Inventory</span>
            </div>
            <div class="nav-item" onclick="App.showView('dispatch')">
                <svg><use href="#icon-dispatch"/></svg>
                <span>Dispatch</span>
            </div>
            <div class="nav-item" onclick="App.showView('settings')">
                <svg><use href="#icon-settings"/></svg>
                <span>Settings</span>
            </div>
        </nav>
    </div>

    <!-- FileSaver.js (minified) to enable file saving -->
    <script>
    /*
    FileSaver.js
    A saveAs() FileSaver implementation.
    
    By Eli Grey, http://eligrey.com
    
    See https://github.com/eligrey/FileSaver.js/blob/master/LICENSE.md
    */
    var saveAs=saveAs||function(e){"use strict";if(typeof e==="undefined"||typeof navigator!=="undefined"&&/MSIE [1-9]\./.test(navigator.userAgent)){return}var t=e.document,n=function(){return e.URL||e.webkitURL||e},r=t.createElementNS("http://www.w3.org/1999/xhtml","a"),o="download"in r,a=function(e){var t=new MouseEvent("click");e.dispatchEvent(t)},i=/constructor/i.test(e.HTMLElement)||e.safari,f=/CriOS\/[\d]+/.test(navigator.userAgent),u=function(t){(e.setImmediate||e.setTimeout)(function(){throw t},0)},s="application/octet-stream",c=1e3*40,l=function(e){var t=function(){if(typeof e==="string"){n().revokeObjectURL(e)}else{e.remove()}};setTimeout(t,c)},p=function(e,t,n){t=[].concat(t);var r=t.length;while(r--){var o=e["on"+t[r]];if(typeof o==="function"){try{o.call(e,n||e)}catch(a){u(a)}}}},d=function(e){if(/^\s*(?:text\/\S*|application\/xml|\S*\/\S*\+xml)\s*;.*charset\s*=\s*utf-8/i.test(e.type)){return new Blob([String.fromCharCode(65279),e],{type:e.type})}return e},g=function(t,u,c){if(!c){t=d(t)}var g=this,v=t.type,m=v===s,y,h=function(){p(g,"writestart progress write writeend".split(" "))},S=function(){if(y&&i&&typeof y!=="string"){l(y)}if(f&&h.readyState!==h.DONE||m){e.location.href=e.location.pathname.slice(0,e.location.pathname.lastIndexOf("/")+1)+u;return}var t=function(e){var t=new XMLHttpRequest;t.open("GET",u,true);t.responseType="blob";t.onload=function(e){if(this.status===200||this.status===0){var n=this.response;var r=new FileReader;r.onload=function(){var e=new Blob([this.result],{type:n.type});var t=new MouseEvent("click");var r=document.createEvent("MouseEvents");r.initMouseEvent("click",true,true,window,0,0,0,0,0,false,false,false,false,0,null);var i=document.createElement("a");i.href=window.URL.createObjectURL(e);i.download=u;i.dispatchEvent(r)}};r.readAsArrayBuffer(n)};t.send()}};if(m){y=e.open(u,"_blank");if(y){h();return}else{S();return}}if(o){r.href=n().createObjectURL(t);r.download=u;setTimeout(function(){a(r);h();l(r)},0);return}h();if(navigator.msSaveBlob){navigator.msSaveBlob(t,u);return}S()},v=g.prototype,m=function(e,t,n){return new g(e,t||e.name||"download",n)};if(typeof module!=="undefined"&&module.exports){module.exports.saveAs=m}else if(typeof define!=="undefined"&&define!==null&&define.amd!==null){define([],function(){return m})}else{e.saveAs=m}};
    </script>

    <!-- Main Application Logic -->
    <script>
        const App = (() => {
            const MACHINES = [
                { id: 'sheet_cutting', name: 'Sheet Cutting' },
                { id: 'paper_pasting', name: 'Paper Pasting' },
                { id: 'rotary_die_cutting', name: 'Rotary Die Cutting' },
                { id: 'slotting', name: 'Slotting' },
                { id: 'die_punching', name: 'Die Punching' },
                { id: 'box_stitching', name: 'Box Stitching' }
            ];

            let state = {
                companies: [],
                products: [],
                production: [],
                inventory: [],
                dispatches: [],
                currentView: 'dashboard'
            };

            const selectors = {
                headerTitle: document.getElementById('header-title'),
                mainContent: document.getElementById('main-content'),
                navItems: document.querySelectorAll('.nav-item'),
                // Views
                dashboardList: document.getElementById('dashboard-machine-list'),
                productionList: document.getElementById('production-list'),
                inventoryList: document.getElementById('inventory-list'),
                dispatchLogList: document.getElementById('dispatch-log-list'),
                // Modals
                addProductModal: document.getElementById('modal-add-product'),
                updateProgressModal: document.getElementById('modal-update-progress'),
                addNoteModal: document.getElementById('modal-add-note'),
                addDispatchModal: document.getElementById('modal-add-dispatch'),
                // Add Product Form
                productForm: document.getElementById('form-add-product'),
                companyInput: document.getElementById('product-company'),
                companyAutocomplete: document.getElementById('company-autocomplete-list'),
                productInput: document.getElementById('product-name'),
                productAutocomplete: document.getElementById('product-autocomplete-list'),
                dimensionsInput: document.getElementById('product-dimensions'),
                qtyInput: document.getElementById('product-qty'),
                machinesContainer: document.getElementById('product-machines'),
                // Update Progress Form
                progressForm: document.getElementById('form-update-progress'),
                progressModalTitle: document.getElementById('progress-modal-title'),
                progressProductionId: document.getElementById('progress-production-id'),
                progressMachineName: document.getElementById('progress-machine-name'),
                progressMachineLabel: document.getElementById('progress-machine-label'),
                progressTotalQtyLabel: document.getElementById('progress-total-qty-label'),
                progressQtyDone: document.getElementById('progress-qty-done'),
                // Note Form
                noteProductionId: document.getElementById('note-production-id'),
                noteText: document.getElementById('note-text'),
                // Dispatch Form
                dispatchPartyName: document.getElementById('dispatch-party-name'),
                dispatchInventoryList: document.getElementById('dispatch-inventory-list'),
            };

            const init = () => {
                loadState();
                setupEventListeners();
                renderAll();
                showView(state.currentView || 'dashboard');
            };

            const saveState = () => {
                try {
                    localStorage.setItem('plantSupervisorData', JSON.stringify(state));
                } catch (e) {
                    console.error("Error saving state to localStorage:", e);
                    alert("Could not save data. Your browser's storage might be full.");
                }
            };

            const loadState = () => {
                const data = localStorage.getItem('plantSupervisorData');
                if (data) {
                    state = JSON.parse(data);
                }
            };
            
            const renderAll = () => {
                renderDashboard();
                renderProductionList();
                renderInventoryList();
                renderDispatchLog();
                renderMachineCheckboxes();
            };
            
            // --- VIEW MANAGEMENT ---
            const showView = (viewId) => {
                state.currentView = viewId;
                document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
                document.getElementById(`view-${viewId}`).classList.add('active');
                
                selectors.navItems.forEach(item => item.classList.remove('active'));
                const activeNavItem = document.querySelector(`.nav-item[onclick="App.showView('${viewId}')"]`);
                if(activeNavItem) activeNavItem.classList.add('active');

                selectors.headerTitle.textContent = viewId.charAt(0).toUpperCase() + viewId.slice(1);
                saveState();
            };

            // --- RENDER FUNCTIONS ---
            const renderDashboard = () => {
                let html = '';
                const productionByMachine = {};
                state.production.forEach(p => {
                    p.machineSteps.forEach(step => {
                        if (!productionByMachine[step.machine]) {
                            productionByMachine[step.machine] = [];
                        }
                        if (step.status !== 'Completed') {
                           productionByMachine[step.machine].push({
                               productName: getProduct(p.productId)?.name || 'Unknown Product',
                               companyName: getCompany(getProduct(p.productId)?.companyId)?.name || 'Unknown Company',
                               qty: p.totalQty
                           });
                        }
                    });
                });

                MACHINES.forEach(machine => {
                    const tasks = productionByMachine[machine.name] || [];
                    html += `
                        <div class="card">
                            <div class="card-header">${machine.name}</div>
                            <div class="card-body">
                                ${tasks.length > 0 ? `
                                    <p><strong>${tasks.length}</strong> item(s) in queue.</p>
                                    <ul>
                                        ${tasks.slice(0, 3).map(t => `<li>${t.productName} (${t.companyName}) - Qty: ${t.qty}</li>`).join('')}
                                    </ul>
                                    ${tasks.length > 3 ? '<p>...</p>' : ''}
                                ` : `
                                    <p class="empty-state" style="padding:10px 0;">No pending tasks.</p>
                                `}
                            </div>
                        </div>
                    `;
                });
                selectors.dashboardList.innerHTML = html;
            };

            const renderProductionList = () => {
                if (state.production.length === 0) {
                    selectors.productionList.innerHTML = `<div class="empty-state">No products in production. Tap the '+' button to add one.</div>`;
                    return;
                }
                
                let html = '';
                [...state.production].reverse().forEach(p => {
                    const product = getProduct(p.productId);
                    const company = getCompany(product?.companyId);
                    const completedSteps = p.machineSteps.filter(s => s.status === 'Completed').length;
                    const totalSteps = p.machinesInvolved.length;
                    const progress = totalSteps > 0 ? (completedSteps / totalSteps) * 100 : 0;

                    html += `
                        <div class="card">
                            <div class="card-header">
                                ${product?.name || 'Unknown Product'}
                                <button class="note-btn" onclick="App.showNoteModal('${p.productionId}')">+</button>
                            </div>
                            <div class="card-body">
                                <p><strong>Company:</strong> ${company?.name || 'Unknown'}</p>
                                <p><strong>Dimensions:</strong> ${product?.dimensions || 'N/A'}</p>
                                <p><strong>Total Qty:</strong> ${p.totalQty}</p>
                                <div class="progress-bar">
                                    <div class="progress-bar-fill" style="width: ${progress.toFixed(0)}%;">${progress.toFixed(0)}%</div>
                                </div>
                                <ul class="machine-status-list">
                                    ${p.machineSteps.map(step => `
                                        <li>
                                            <span>
                                                ${step.machine}
                                                <small style="display: block; color: var(--text-light)">
                                                   Qty Done: ${step.qtyDone} / ${p.totalQty}
                                                   ${step.timestamp ? ` | ${new Date(step.timestamp).toLocaleString()}` : ''}
                                                </small>
                                            </span>
                                            ${step.status === 'Completed' ? `
                                                <span class="badge badge-success">Done</span>
                                            ` : `
                                                <button class="btn btn-secondary btn-small" onclick="App.showProgressModal('${p.productionId}', '${step.machine}')">Update</button>
                                            `}
                                        </li>
                                    `).join('')}
                                </ul>
                                ${p.notes ? `<div style="background:#f0f0f0; padding:8px; border-radius:4px; margin-top:10px;"><p><strong>Note:</strong> ${p.notes}</p></div>` : ''}
                                <button class="btn btn-success btn-block" onclick="App.moveCompletedToInventory('${p.productionId}')">Move Completed Qty to Inventory</button>
                            </div>
                        </div>
                    `;
                });
                selectors.productionList.innerHTML = html;
            };

            const renderInventoryList = () => {
                if (state.inventory.length === 0) {
                    selectors.inventoryList.innerHTML = `<div class="empty-state">Inventory is empty.</div>`;
                    return;
                }
                let html = '';
                const groupedInventory = {};
                state.inventory.forEach(item => {
                    if (!groupedInventory[item.productId]) {
                        groupedInventory[item.productId] = { ...getProduct(item.productId), qty: 0 };
                    }
                    groupedInventory[item.productId].qty += item.qty;
                });

                Object.values(groupedInventory).forEach(item => {
                    if (item.qty <= 0) return;
                    const company = getCompany(item.companyId);
                    html += `
                        <div class="card">
                            <div class="card-header">${item.name}</div>
                            <div class="card-body">
                                <p><strong>Company:</strong> ${company?.name || 'Unknown'}</p>
                                <p><strong>Dimensions:</strong> ${item.dimensions || 'N/A'}</p>
                                <p><strong>Available Qty:</strong> <strong style="font-size:1.2rem;">${item.qty}</strong></p>
                            </div>
                        </div>
                    `;
                });
                selectors.inventoryList.innerHTML = html || `<div class="empty-state">Inventory is empty.</div>`;
            };

            const renderDispatchLog = () => {
                 const today = new Date().toLocaleDateString();
                 const todaysDispatches = state.dispatches.filter(d => new Date(d.date).toLocaleDateString() === today);
                
                if (todaysDispatches.length === 0) {
                    selectors.dispatchLogList.innerHTML = `<div class="empty-state">No dispatches logged today.</div>`;
                    return;
                }
                let html = '';
                [...todaysDispatches].reverse().forEach((d, index) => {
                     const dispatchNum = todaysDispatches.length - index;
                     html += `
                        <div class="card">
                            <div class="card-header">Dispatch #${dispatchNum} (${new Date(d.date).toLocaleTimeString()})</div>
                            <div class="card-body">
                                <p><strong>Recipient:</strong> ${d.partyName}</p>
                                <ul>
                                    ${d.items.map(item => {
                                        const product = getProduct(item.productId);
                                        return `<li>${product?.name || 'Unknown Product'} - <strong>Qty: ${item.qty}</strong></li>`;
                                    }).join('')}
                                </ul>
                            </div>
                        </div>
                     `;
                });
                selectors.dispatchLogList.innerHTML = html;
            };

            const renderMachineCheckboxes = () => {
                selectors.machinesContainer.innerHTML = MACHINES.map(m => `
                    <label>
                        <input type="checkbox" name="machines" value="${m.name}">
                        ${m.name}
                    </label>
                `).join('');
            };

            // --- MODAL & FORM HANDLING ---
            const handleProductForm = (e) => {
                e.preventDefault();
                const companyName = selectors.companyInput.value.trim();
                const productName = selectors.productInput.value.trim();
                
                let company = state.companies.find(c => c.name.toLowerCase() === companyName.toLowerCase());
                if (!company) {
                    company = { id: `cmp_${Date.now()}`, name: companyName };
                    state.companies.push(company);
                }

                let product = state.products.find(p => p.name.toLowerCase() === productName.toLowerCase() && p.companyId === company.id);
                if (!product) {
                    product = { 
                        id: `prd_${Date.now()}`, 
                        name: productName,
                        companyId: company.id,
                        dimensions: selectors.dimensionsInput.value.trim()
                    };
                    state.products.push(product);
                }
                
                const selectedMachines = Array.from(document.querySelectorAll('#product-machines input:checked')).map(cb => cb.value);
                if(selectedMachines.length === 0) {
                    alert('Please select at least one machine for the production process.');
                    return;
                }

                const newProductionRun = {
                    productionId: `run_${Date.now()}`,
                    productId: product.id,
                    totalQty: parseInt(selectors.qtyInput.value),
                    machinesInvolved: selectedMachines,
                    machineSteps: selectedMachines.map(machineName => ({
                        machine: machineName,
                        qtyDone: 0,
                        status: 'Pending',
                        timestamp: null
                    })),
                    notes: null,
                    dateAdded: new Date().toISOString()
                };

                state.production.push(newProductionRun);
                saveState();
                renderAll();
                hideModal('modal-add-product');
                showView('production');
                selectors.productForm.reset();
            };
            
            const showProgressModal = (productionId, machineName) => {
                const p = state.production.find(pr => pr.productionId === productionId);
                if (!p) return;
                const step = p.machineSteps.find(s => s.machine === machineName);
                if (!step) return;

                selectors.progressProductionId.value = productionId;
                selectors.progressMachineName.value = machineName;
                selectors.progressMachineLabel.textContent = machineName;
                selectors.progressTotalQtyLabel.textContent = p.totalQty;
                selectors.progressQtyDone.value = '';
                selectors.progressQtyDone.max = p.totalQty - step.qtyDone;
                selectors.progressQtyDone.placeholder = `Max: ${p.totalQty - step.qtyDone}`;

                showModal('modal-update-progress');
            };

            const handleProgressUpdate = (e) => {
                e.preventDefault();
                const productionId = selectors.progressProductionId.value;
                const machineName = selectors.progressMachineName.value;
                const qtyDone = parseInt(selectors.progressQtyDone.value);

                const p = state.production.find(pr => pr.productionId === productionId);
                const step = p.machineSteps.find(s => s.machine === machineName);
                
                if (qtyDone > 0 && (step.qtyDone + qtyDone) <= p.totalQty) {
                    step.qtyDone += qtyDone;
                    if (step.qtyDone >= p.totalQty) {
                        step.qtyDone = p.totalQty;
                        step.status = 'Completed';
                        step.timestamp = new Date().toISOString();
                    }
                } else if (qtyDone <= 0) {
                   alert("Please enter a quantity greater than zero.");
                   return;
                } else {
                    alert(`Cannot complete ${qtyDone} items. Only ${p.totalQty - step.qtyDone} items remaining.`);
                    return;
                }
                
                saveState();
                renderAll();
                hideModal('modal-update-progress');
            };
            
            const showNoteModal = (productionId) => {
                const p = state.production.find(pr => pr.productionId === productionId);
                if (!p) return;
                selectors.noteProductionId.value = productionId;
                selectors.noteText.value = p.notes || '';
                showModal('modal-add-note');
            };
            
            const handleAddNote = (e) => {
                e.preventDefault();
                const productionId = selectors.noteProductionId.value;
                const note = selectors.noteText.value.trim();
                const p = state.production.find(pr => pr.productionId === productionId);
                if (p) {
                    p.notes = note;
                    saveState();
                    renderProductionList();
                    hideModal('modal-add-note');
                }
            };

            const moveCompletedToInventory = (productionId) => {
                const p = state.production.find(pr => pr.productionId === productionId);
                if (!p) return;

                // Find the bottleneck: the minimum quantity completed across all steps
                const minQtyDone = Math.min(...p.machineSteps.map(s => s.qtyDone));
                
                // Find quantity already moved from this production run
                const alreadyMovedQty = state.inventory
                    .filter(item => item.sourceProductionId === productionId)
                    .reduce((sum, item) => sum + item.qty, 0);

                const transferableQty = minQtyDone - alreadyMovedQty;

                if (transferableQty <= 0) {
                    alert('No new completed quantities to move to inventory.');
                    return;
                }

                if (confirm(`Move ${transferableQty} units of ${getProduct(p.productId).name} to inventory?`)) {
                    state.inventory.push({
                        inventoryId: `inv_${Date.now()}`,
                        productId: p.productId,
                        qty: transferableQty,
                        sourceProductionId: productionId,
                        dateMoved: new Date().toISOString()
                    });
                    
                    // If all items are moved, we could remove the production run.
                    // For now, we'll keep it for record-keeping.
                    // If all items are moved (minQtyDone == p.totalQty), you might want to archive it.
                    if (minQtyDone >= p.totalQty) {
                        // Optional: remove from active production
                        // state.production = state.production.filter(pr => pr.productionId !== productionId);
                    }

                    saveState();
                    renderAll();
                    alert(`${transferableQty} units moved successfully.`);
                }
            };
            
            const handleDispatch = (e) => {
                e.preventDefault();
                const partyName = selectors.dispatchPartyName.value.trim();
                const itemsToDispatch = [];
                document.querySelectorAll('#dispatch-inventory-list .dispatch-item').forEach(itemEl => {
                    const qtyInput = itemEl.querySelector('input[type="number"]');
                    const qty = parseInt(qtyInput.value || '0');
                    if (qty > 0) {
                        itemsToDispatch.push({
                            productId: itemEl.dataset.productId,
                            qty: qty
                        });
                    }
                });

                if(itemsToDispatch.length === 0) {
                    alert("Please enter a quantity for at least one product.");
                    return;
                }

                // Update inventory
                itemsToDispatch.forEach(dispatchItem => {
                    let qtyToReduce = dispatchItem.qty;
                    // Find all inventory entries for this product and reduce from them
                    const inventoryEntries = state.inventory.filter(inv => inv.productId === dispatchItem.productId);
                    for (const entry of inventoryEntries) {
                        if (qtyToReduce === 0) break;
                        const reduction = Math.min(entry.qty, qtyToReduce);
                        entry.qty -= reduction;
                        qtyToReduce -= reduction;
                    }
                });
                // Clean up empty inventory items
                state.inventory = state.inventory.filter(item => item.qty > 0);

                // Create dispatch record
                const newDispatch = {
                    dispatchId: `disp_${Date.now()}`,
                    partyName: partyName,
                    items: itemsToDispatch,
                    date: new Date().toISOString()
                };
                state.dispatches.push(newDispatch);

                saveState();
                exportData(true); // Auto-export after dispatch
                renderAll();
                hideModal('modal-add-dispatch');
                alert("Dispatch logged successfully! A backup file has been saved.");
            };
            
            const renderDispatchModalInventory = () => {
                let html = '';
                const groupedInventory = {};
                state.inventory.forEach(item => {
                    if (item.qty <= 0) return;
                    if (!groupedInventory[item.productId]) {
                        groupedInventory[item.productId] = { ...getProduct(item.productId), qty: 0 };
                    }
                    groupedInventory[item.productId].qty += item.qty;
                });
                
                if (Object.keys(groupedInventory).length === 0) {
                    html = '<div class="empty-state">No items in inventory to dispatch.</div>';
                } else {
                    Object.values(groupedInventory).forEach(item => {
                        const company = getCompany(item.companyId);
                        html += `
                            <div class="dispatch-item card" data-product-id="${item.id}" style="border-left-color: var(--secondary-color); margin-bottom: 10px;">
                                <p><strong>${item.name}</strong> (${company.name})</p>
                                <p>Available: ${item.qty}</p>
                                <div class="form-group">
                                    <label>Dispatch Qty:</label>
                                    <input type="number" class="form-control" min="0" max="${item.qty}" placeholder="0">
                                </div>
                            </div>
                        `;
                    });
                }
                selectors.dispatchInventoryList.innerHTML = html;
            };

            // --- AUTOCOMPLETE LOGIC ---
            const setupAutocomplete = (inputEl, listEl, sourceArray, property) => {
                inputEl.addEventListener('input', () => {
                    const value = inputEl.value.toLowerCase();
                    listEl.innerHTML = '';
                    if (!value) return;

                    const suggestions = sourceArray
                        .filter(item => item[property].toLowerCase().includes(value))
                        .slice(0, 5);
                    
                    suggestions.forEach(item => {
                        const div = document.createElement('div');
                        div.className = 'autocomplete-item';
                        div.textContent = item[property];
                        div.onclick = () => {
                            inputEl.value = item[property];
                            listEl.innerHTML = '';
                             // If it's the product input, also fill dimensions
                            if (inputEl === selectors.productInput) {
                                selectors.dimensionsInput.value = item.dimensions || '';
                            }
                        };
                        listEl.appendChild(div);
                    });

                    const exists = sourceArray.some(item => item[property].toLowerCase() === value);
                    if (!exists) {
                         const addDiv = document.createElement('div');
                         addDiv.className = 'autocomplete-item add-new';
                         addDiv.textContent = `+ Add "${inputEl.value}"`;
                         addDiv.onclick = () => { listEl.innerHTML = ''; };
                         listEl.appendChild(addDiv);
                    }
                });
                document.addEventListener('click', (e) => {
                    if (e.target !== inputEl) {
                        listEl.innerHTML = '';
                    }
                });
            };

            // --- DATA HELPERS ---
            const getProduct = (productId) => state.products.find(p => p.id === productId);
            const getCompany = (companyId) => state.companies.find(c => c.id === companyId);
            
            const exportData = (isAuto = false) => {
                try {
                    const dataStr = JSON.stringify(state, null, 2);
                    const blob = new Blob([dataStr], {type: "application/json;charset=utf-8"});
                    const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
                    saveAs(blob, `supervisor_data_${timestamp}.json`);
                    if(!isAuto) alert('Data exported successfully!');
                } catch(e) {
                    console.error("Export failed", e);
                    alert("Could not export data.");
                }
            };
            
            const importData = (event) => {
                const file = event.target.files[0];
                if (!file) return;
                
                if(!confirm("Are you sure you want to import this file? It will OVERWRITE all current data.")) {
                    event.target.value = null; // Reset file input
                    return;
                }

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const importedState = JSON.parse(e.target.result);
                        // Basic validation
                        if (importedState.companies && importedState.products && importedState.production) {
                            state = importedState;
                            saveState();
                            renderAll();
                            showView('dashboard');
                            alert('Data imported successfully!');
                        } else {
                            alert('Import failed: Invalid data file format.');
                        }
                    } catch (err) {
                        alert('Import failed: Could not parse the file. Ensure it is a valid JSON backup.');
                        console.error(err);
                    } finally {
                        event.target.value = null; // Reset file input
                    }
                };
                reader.readAsText(file);
            };

            const setupEventListeners = () => {
                // Autocomplete setup
                setupAutocomplete(selectors.companyInput, selectors.companyAutocomplete, state.companies, 'name');
                
                selectors.companyInput.addEventListener('change', () => { // When company changes, filter product suggestions
                    const companyName = selectors.companyInput.value.trim();
                    const company = state.companies.find(c => c.name === companyName);
                    const filteredProducts = company ? state.products.filter(p => p.companyId === company.id) : state.products;
                    setupAutocomplete(selectors.productInput, selectors.productAutocomplete, filteredProducts, 'name');
                });
                // Initial product autocomplete setup
                setupAutocomplete(selectors.productInput, selectors.productAutocomplete, state.products, 'name');
            };

            window.showModal = (id) => {
                if (id === 'modal-add-dispatch') renderDispatchModalInventory();
                document.getElementById(id).classList.add('active');
            };
            window.hideModal = (id) => document.getElementById(id).classList.remove('active');

            return {
                init, showView, handleProductForm, showProgressModal, handleProgressUpdate,
                moveCompletedToInventory, handleDispatch, exportData, importData,
                showNoteModal, handleAddNote
            };
        })();

        document.addEventListener('DOMContentLoaded', App.init);
    </script>
</body>
</html>