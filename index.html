<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Production Tracker - AE</title>
    <style>
        :root {
            --primary-color: #2c3e50; --secondary-color: #3498db; --background-color: #ecf0f1;
            --card-background: #ffffff; --text-color: #34495e; --text-light: #7f8c8d;
            --success-color: #27ae60; --warning-color: #f39c12; --danger-color: #e74c3c;
            --border-color: #dfe6e9; --disabled-color: #bdc3c7;
            --font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        html, body { font-family: var(--font-family); background-color: var(--background-color); color: var(--text-color); overscroll-behavior-y: contain; }
        #app { display: flex; flex-direction: column; height: 100dvh; }
        header { background-color: var(--primary-color); color: white; padding: 15px; text-align: center; font-size: 1.1rem; font-weight: 600; box-shadow: 0 2px 4px rgba(0,0,0,0.1); position: sticky; top: 0; z-index: 100; }
        main { flex-grow: 1; overflow-y: auto; padding: 15px; }
        .view { display: none; }
        .view.active { display: block; animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .card { background: var(--card-background); border-radius: 12px; padding: 15px; margin-bottom: 15px; box-shadow: 0 3px 6px rgba(0,0,0,0.05); border-left: 5px solid var(--secondary-color); }
        .card-header { font-weight: 600; font-size: 1.1rem; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
        .card-body p { margin-bottom: 8px; color: var(--text-light); font-size: 0.95rem; }
        .card-body p strong { color: var(--text-color); }
        .list-group-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid var(--border-color); }
        .list-group-item:last-child { border-bottom: none; }
        .btn { display: inline-block; padding: 12px 20px; border-radius: 8px; border: none; font-size: 1rem; font-weight: 600; cursor: pointer; text-align: center; transition: all 0.2s ease; }
        .btn:active { transform: scale(0.98); }
        .btn-primary { background-color: var(--primary-color); color: white; }
        .btn-secondary { background-color: var(--secondary-color); color: white; }
        .btn-success { background-color: var(--success-color); color: white; }
        .btn-block { display: block; width: 100%; margin-top: 10px; }
        .btn-small { padding: 6px 12px; font-size: 0.8rem; }
        .btn:disabled { background-color: var(--disabled-color); cursor: not-allowed; opacity: 0.7; }
        .fab { position: fixed; bottom: 80px; right: 20px; width: 56px; height: 56px; border-radius: 50%; background-color: var(--secondary-color); color: white; display: flex; align-items: center; justify-content: center; font-size: 2rem; box-shadow: 0 4px 10px rgba(0,0,0,0.2); border: none; cursor: pointer; z-index: 999; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 600; font-size: 0.9rem; }
        .form-control { width: 100%; padding: 12px; font-size: 1rem; border: 1px solid var(--border-color); border-radius: 8px; background-color: #fff; appearance: none; }
        .autocomplete-container { position: relative; }
        .autocomplete-list { position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid var(--border-color); border-radius: 0 0 8px 8px; max-height: 150px; overflow-y: auto; z-index: 1000; }
        .autocomplete-item { padding: 12px; cursor: pointer; }
        .autocomplete-item:hover, .autocomplete-item.add-new { background-color: var(--background-color); }
        .autocomplete-item.add-new { color: var(--secondary-color); font-weight: 600; }
        #bottom-nav { display: flex; justify-content: space-around; background: var(--card-background); padding: 10px 0; box-shadow: 0 -2px 5px rgba(0,0,0,0.1); position: sticky; bottom: 0; z-index: 100; }
        .nav-item { display: flex; flex-direction: column; align-items: center; cursor: pointer; color: var(--text-light); padding: 5px 10px; border-radius: 8px; transition: all 0.2s; }
        .nav-item.active { color: var(--secondary-color); font-weight: 600; }
        .nav-item svg { width: 24px; height: 24px; margin-bottom: 4px; }
        .nav-item span { font-size: 0.75rem; }
        .modal { display: none; position: fixed; z-index: 1001; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); justify-content: center; align-items: center; }
        .modal.active { display: flex; animation: fadeIn 0.2s; }
        .modal-content { background-color: var(--background-color); margin: 15px; padding: 20px; border-radius: 12px; width: 100%; max-width: 500px; max-height: 90vh; display: flex; flex-direction: column; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        .modal-header { font-size: 1.2rem; font-weight: 600; padding-bottom: 15px; border-bottom: 1px solid var(--border-color); margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; }
        .modal-body { overflow-y: auto; }
        .modal-close { font-size: 1.8rem; line-height: 1; cursor: pointer; border: none; background: none; }
        .progress-bar { width: 100%; height: 20px; background-color: #e9ecef; border-radius: 10px; overflow: hidden; margin: 10px 0; }
        .progress-bar-fill { height: 100%; background-color: var(--success-color); text-align: center; color: white; font-size: 0.8rem; line-height: 20px; font-weight: 600; transition: width 0.4s ease-in-out; }
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }
        .stat-card { background: var(--secondary-color); color: white; padding: 15px; border-radius: 8px; text-align: center; }
        .stat-card .stat-number { font-size: 2rem; font-weight: 700; }
        .stat-card .stat-label { font-size: 0.9rem; opacity: 0.9; }
        .section-title { font-size: 1.2rem; font-weight: 600; margin-bottom: 10px; padding-bottom: 5px; border-bottom: 2px solid var(--secondary-color); }
        .empty-state { text-align: center; color: var(--text-light); padding: 40px 20px; }
        .badge { padding: 4px 10px; border-radius: 12px; font-size: 0.8rem; font-weight: 600; color: white; }
        .badge-success { background-color: var(--success-color); }
        .badge-warning { background-color: var(--warning-color); color: var(--text-color); }
        .date-header { font-weight: 600; color: var(--text-light); background-color: var(--background-color); padding: 8px 15px; margin: 20px -15px 10px -15px; border-top: 1px solid var(--border-color); border-bottom: 1px solid var(--border-color); }
    </style>
</head>
<body>
    <svg style="display:none;">
        <symbol id="icon-dashboard" viewBox="0 0 24 24"><path fill="currentColor" d="M13 3h-2v10h2V3zm4.83 2.17l-1.42 1.42A6.92 6.92 0 0 1 19 12c0 3.87-3.13 7-7 7s-7-3.13-7-7c0-1.7.6-3.24 1.58-4.42L5.17 5.17A8.932 8.932 0 0 0 3 12a9 9 0 0 0 9 9 9 9 0 0 0 9-9c0-2.39-1.01-4.54-2.17-6.83z"/></symbol>
        <symbol id="icon-production" viewBox="0 0 24 24"><path fill="currentColor" d="M20.5 11H19V7c0-1.1-.9-2-2-2h-4V3.5C13 2.12 11.88 1 10.5 1S8 2.12 8 3.5V5H4c-1.1 0-1.99.9-1.99 2v3.8H3.5c1.49 0 2.7 1.21 2.7 2.7s-1.21 2.7-2.7 2.7H2v3.8c0 1.1.9 2 2 2h4v1.5c0 1.38 1.12 2.5 2.5 2.5s2.5-1.12 2.5-2.5V19h4c1.1 0 2-.9 2-2v-4h1.5c1.38 0 2.5-1.12 2.5-2.5S21.88 11 20.5 11z"/></symbol>
        <symbol id="icon-inventory" viewBox="0 0 24 24"><path fill="currentColor" d="M21 16.5c0 .83-.67 1.5-1.5 1.5s-1.5-.67-1.5-1.5V13H6v3.5c0 .83-.67 1.5-1.5 1.5S3 17.33 3 16.5V7c0-1.1.9-2 2-2h14c1.1 0 2 .9 2 2v9.5zM11 9H9v2h2V9zm4 0h-2v2h2V9z"/></symbol>
        <symbol id="icon-dispatch" viewBox="0 0 24 24"><path fill="currentColor" d="M20 8h-3V4H3c-1.1 0-2 .9-2 2v11h2c0 1.66 1.34 3 3 3s3-1.34 3-3h6c0 1.66 1.34 3 3 3s3-1.34 3-3h2v-5l-3-4zM6 18.5c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zm13.5-9l1.96 2.5H17V9.5h3.5zM18 18.5c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5z"/></symbol>
        <symbol id="icon-settings" viewBox="0 0 24 24"><path fill="currentColor" d="M19.43 12.98c.04-.32.07-.64.07-.98s-.03-.66-.07-.98l2.11-1.65c.19-.15.24-.42.12-.64l-2-3.46c-.12-.22-.39-.3-.61-.22l-2.49 1c-.52-.4-1.08-.73-1.69-.98l-.38-2.65C14.46 2.18 14.25 2 14 2h-4c-.25 0-.46.18-.49.42l-.38 2.65c-.61.25-1.17.59-1.69.98l-2.49-1c-.23-.09-.49 0-.61.22l-2 3.46c-.13.22-.07.49.12.64l2.11 1.65c-.04.32-.07.65-.07.98s.03.66.07.98l-2.11 1.65c-.19-.15-.24.42-.12.64l2 3.46c.12.22.39.3.61-.22l2.49-1c.52.4 1.08.73 1.69.98l.38 2.65c.03.24.24.42.49.42h4c.25 0 .46-.18.49-.42l.38-2.65c.61-.25 1.17-.59 1.69-.98l2.49 1c.23.09.49 0 .61-.22l2-3.46c.12-.22.07-.49-.12-.64l-2.11-1.65zM12 15.5c-1.93 0-3.5-1.57-3.5-3.5s1.57-3.5 3.5-3.5 3.5 1.57 3.5 3.5-1.57 3.5-3.5 3.5z"/></symbol>
    </svg>

    <div id="app">
        <header>Aryan Enterprises - Packlite Pvt Ltd</header>
        <main id="main-content">
            <div id="view-dashboard" class="view active"></div><div id="view-production" class="view"></div>
            <div id="view-inventory" class="view"></div><div id="view-dispatch" class="view"></div>
            <div id="view-settings" class="view"></div>
        </main>
        <nav id="bottom-nav">
            <div class="nav-item active" onclick="App.showView('dashboard')"><svg><use href="#icon-dashboard"/></svg><span>Dashboard</span></div>
            <div class="nav-item" onclick="App.showView('production')"><svg><use href="#icon-production"/></svg><span>Production</span></div>
            <div class="nav-item" onclick="App.showView('inventory')"><svg><use href="#icon-inventory"/></svg><span>Inventory</span></div>
            <div class="nav-item" onclick="App.showView('dispatch')"><svg><use href="#icon-dispatch"/></svg><span>Dispatch</span></div>
            <div class="nav-item" onclick="App.showView('settings')"><svg><use href="#icon-settings"/></svg><span>Settings</span></div>
        </nav>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script>
        const App = (() => {
            const MACHINES = ['Sheet Cutting', 'Paper Pasting', 'Rotary Die Cutting', 'Slotting', 'Die Punching', 'Box Stitching'];
            let state = { companies: [], products: [], production: [], inventory: [], dispatches: [], productionLog: [], currentView: 'dashboard' };

            const init = () => { loadState(); renderAllViews(); showView(state.currentView || 'dashboard'); document.addEventListener('click', (e) => { if (!e.target.closest('.autocomplete-container')) { document.querySelectorAll('.autocomplete-list').forEach(l => l.innerHTML = ''); } }); };
            const saveState = () => localStorage.setItem('plantSupervisorData', JSON.stringify(state));
            const loadState = () => { const data = localStorage.getItem('plantSupervisorData'); if (data) { state = JSON.parse(data); state.productionLog = state.productionLog || []; state.dispatches = state.dispatches || []; state.inventory = state.inventory || []; state.production = state.production || []; } };
            const renderAllViews = () => Object.keys(renderFunctions).forEach(view => renderFunctions[view]());
            const showView = (viewId) => { state.currentView = viewId; document.querySelectorAll('.view').forEach(v => v.classList.remove('active')); document.getElementById(`view-${viewId}`).classList.add('active'); document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active')); document.querySelector(`.nav-item[onclick="App.showView('${viewId}')"]`)?.classList.add('active'); saveState(); };

            const renderFunctions = {
                dashboard: () => { document.getElementById('view-dashboard').innerHTML = `<div class="stats-grid"><div class="stat-card" style="background-color: var(--warning-color);"><div class="stat-number">${state.production.length}</div><div class="stat-label">In Production</div></div><div class="stat-card" style="background-color: var(--success-color);"><div class="stat-number">${state.inventory.reduce((s, i) => s + i.qty, 0)}</div><div class="stat-label">In Inventory</div></div></div><div class="section-title">Today's Focus</div><div>${state.production.length > 0 ? [...state.production].reverse().map(p => { const pr = getProduct(p.productId), c = getCompany(pr?.companyId), prog = p.machinesInvolved.length > 0 ? Math.round((p.machineSteps.filter(s => s.status === 'Completed').length / p.machinesInvolved.length) * 100) : 0; return `<div class="card"><div class="card-header">${pr?.name || '...'}</div><div class="card-body"><p><strong>Company:</strong> ${c?.name || '...'}</p><div class="progress-bar"><div class="progress-bar-fill" style="width: ${prog}%;">${prog}%</div></div></div></div>` }).join('') : '<div class="empty-state">No active production runs.</div>'}</div><div class="section-title" style="margin-top: 20px;">Machine Status</div><div>${MACHINES.map(m => { const tasks = state.production.filter(p => p.machineSteps.some(s => s.machine === m && s.status !== 'Completed')).length; return `<div class="list-group-item"><span>${m}</span><span class="badge ${tasks > 0 ? 'badge-warning' : 'badge-success'}">${tasks > 0 ? `${tasks} Pending` : 'Idle'}</span></div>` }).join('')}</div>`; },
                production: () => {
                    const view = document.getElementById('view-production');
                    const content = state.production.length === 0 ? `<div class="empty-state">No products in production.</div>` : [...state.production].reverse().map(p => {
                        const product = getProduct(p.productId), company = getCompany(product?.companyId);
                        const progress = p.machinesInvolved.length > 0 ? Math.round((p.machineSteps.filter(s => s.status === 'Completed').length / p.machinesInvolved.length) * 100) : 0;
                        const minQtyDone = Math.min(...p.machineSteps.map(s => s.qtyDone));
                        const transferableQty = minQtyDone - p.qtyMovedToInventory;
                        const buttonDisabled = transferableQty <= 0;
                        const buttonText = buttonDisabled ? "No Units to Move" : `Move ${transferableQty} Completed Units`;
                        return `<div class="card"><div class="card-header">${product?.name || '...'}<button onclick="showNoteModal('${p.productionId}')" style="background:none;border:none;font-size:1.5rem;cursor:pointer;">+</button></div><div class="card-body"><p><strong>Company:</strong> ${company?.name || '...'}</p><p><strong>Total Qty:</strong> ${p.totalQty}</p><div class="progress-bar"><div class="progress-bar-fill" style="width: ${progress}%;">${progress}%</div></div><ul style="list-style:none; padding:0;">${p.machineSteps.map(step => `<li class="list-group-item"><span>${step.machine} <small style="display:block;color:var(--text-light)">Done: ${step.qtyDone}</small></span>${step.status === 'Completed' ? `<span class="badge badge-success">Done</span>` : `<button class="btn btn-secondary btn-small" onclick="showProgressModal('${p.productionId}', '${step.machine}')">Update</button>`}</li>`).join('')}</ul>${p.notes ? `<div style="background:#f0f0f0; padding:8px; border-radius:4px; margin-top:10px;"><p><strong>Note:</strong> ${p.notes}</p></div>` : ''}<button class="btn btn-success btn-block" onclick="App.moveCompletedToInventory('${p.productionId}')" ${buttonDisabled ? 'disabled' : ''}>${buttonText}</button></div></div>`;
                    }).join('');
                    view.innerHTML = `<button class="btn btn-secondary btn-block" onclick="showProductionLogModal()">View Production Log</button><div style="margin-top:15px;">${content}</div><button class="fab" onclick="showAddProductModal()">+</button>`;
                },
                inventory: () => { const grouped = state.inventory.reduce((acc, item) => { if (item.qty <= 0) return acc; if (!acc[item.productId]) acc[item.productId] = { ...getProduct(item.productId), qty: 0 }; acc[item.productId].qty += item.qty; return acc; }, {}); document.getElementById('view-inventory').innerHTML = Object.keys(grouped).length === 0 ? `<div class="empty-state">Inventory is empty.</div>` : Object.values(grouped).map(item => `<div class="card"><div class="card-header">${item.name}</div><div class="card-body"><p><strong>Company:</strong> ${getCompany(item.companyId)?.name || '...'}</p><p><strong>Dimensions:</strong> ${item.dimensions || 'N/A'}</p><p><strong>Available Qty:</strong> <strong style="font-size:1.2rem;">${item.qty}</strong></p></div></div>`).join(''); },
                dispatch: () => { const today = new Date().toLocaleDateString(); const todaysDispatches = state.dispatches.filter(d => new Date(d.date).toLocaleDateString() === today); const pastDispatches = state.dispatches.filter(d => new Date(d.date).toLocaleDateString() !== today); const groupedPast = pastDispatches.reduce((acc, d) => { const dateKey = new Date(d.date).toLocaleDateString('en-CA'); if (!acc[dateKey]) acc[dateKey] = []; acc[dateKey].push(d); return acc; }, {}); document.getElementById('view-dispatch').innerHTML = `<button class="btn btn-primary btn-block" onclick="showDispatchModal()">Create New Dispatch</button><div class="section-title" style="margin-top:20px;">Today's Dispatches</div><div>${todaysDispatches.length > 0 ? [...todaysDispatches].reverse().map((d, i) => `<div class="card"><div class="card-header">Dispatch #${todaysDispatches.length - i} (${new Date(d.date).toLocaleTimeString()})</div><div class="card-body"><p><strong>Recipient:</strong> ${d.partyName}</p><ul>${d.items.map(item => `<li>${getProduct(item.productId)?.name} - <strong>Qty: ${item.qty}</strong></li>`).join('')}</ul></div></div>`).join('') : '<div class="empty-state">No dispatches logged today.</div>'}</div><div class="section-title" style="margin-top:20px;">Past Dispatch Log</div><div>${Object.keys(groupedPast).length > 0 ? Object.keys(groupedPast).sort().reverse().map(dateKey => `<div class="date-header">${new Date(dateKey + 'T00:00:00').toDateString()}</div>${groupedPast[dateKey].reverse().map(d => `<div class="card"><div class="card-header">Dispatch (${new Date(d.date).toLocaleTimeString()})</div><div class="card-body"><p><strong>Recipient:</strong> ${d.partyName}</p><ul>${d.items.map(item => `<li>${getProduct(item.productId)?.name} - <strong>Qty: ${item.qty}</strong></li>`).join('')}</ul></div></div>`).join('')}`).join('') : '<div class="empty-state">No past dispatches found.</div>'}</div>`; },
                settings: () => { document.getElementById('view-settings').innerHTML = `<div class="card"><div class="card-header">Data Management</div><div class="card-body"><p><strong>Important:</strong> "Export" will prompt you to download a backup file of all your data. Save this file in a safe place.</p><button class="btn btn-primary btn-block" onclick="App.exportData()">Export Data Backup</button><hr style="margin: 20px 0; border: 0; border-top: 1px solid var(--border-color);"><p>"Import" will replace all current data with data from a backup file. Use with caution.</p><input type="file" id="import-file-input" style="display:none;" accept=".json" onchange="App.importData(event)"><button class="btn btn-danger btn-block" onclick="document.getElementById('import-file-input').click()">Import from Backup</button></div></div>`; }
            };

            const createModal = (id, title, content) => { let modal = document.getElementById(id); if (modal) modal.remove(); modal = document.createElement('div'); modal.id = id; modal.className = 'modal'; modal.innerHTML = `<div class="modal-content"><div class="modal-header"><span>${title}</span><button class="modal-close" onclick="hideModal('${id}')">&times;</button></div><div class="modal-body">${content}</div></div>`; document.body.appendChild(modal); return modal; };
            window.showAddProductModal = () => createModal('modal-add-product', 'Add New Product', `<form onsubmit="App.handleProductForm(event)"><div class="form-group autocomplete-container"><label for="product-company">Company</label><input type="text" id="product-company" class="form-control" placeholder="Type..." required autocomplete="off" oninput="App.handleAutocomplete(this, 'companies', 'name')"><div class="autocomplete-list"></div></div><div class="form-group autocomplete-container"><label for="product-name">Product Name</label><input type="text" id="product-name" class="form-control" placeholder="e.g., Prime Box" required autocomplete="off" oninput="App.handleAutocomplete(this, 'products', 'name')"><div class="autocomplete-list"></div></div><div class="form-group"><label for="product-dimensions">Dimensions</label><input type="text" id="product-dimensions" class="form-control" placeholder="e.g., 10x8x4"></div><div class="form-group"><label for="product-qty">Total Quantity</label><input type="number" id="product-qty" class="form-control" placeholder="e.g., 5000" required min="1"></div><div class="form-group"><label>Machines Involved</label><div>${MACHINES.map(m => `<label style="display:flex;align-items:center;padding:8px;background-color:var(--background-color);border-radius:6px;margin-bottom:8px;"><input type="checkbox" name="machines" value="${m}" style="margin-right:12px;width:20px;height:20px;">${m}</label>`).join('')}</div></div><button type="submit" class="btn btn-primary btn-block">Add to Production</button></form>`).classList.add('active');
            window.showProgressModal = (pId, mName) => { const p = state.production.find(pr => pr.productionId === pId); if (!p) return; const s = p.machineSteps.find(st => st.machine === mName); createModal('modal-update-progress', 'Update Progress', `<form onsubmit="App.handleProgressUpdate(event)"><input type="hidden" name="pId" value="${pId}"><input type="hidden" name="mName" value="${mName}"><p>Machine: <strong>${mName}</strong></p><p>Total: <strong>${p.totalQty}</strong> | Done: <strong>${s.qtyDone}</strong></p><div class="form-group"><label for="qty">Qty Completed Now</label><input type="number" name="qty" class="form-control" required min="0" max="${p.totalQty - s.qtyDone}" placeholder="Max: ${p.totalQty - s.qtyDone}"></div><button type="submit" class="btn btn-primary btn-block">Update Progress</button></form>`).classList.add('active'); };
            window.showNoteModal = (pId) => { const p = state.production.find(pr => pr.productionId === pId); createModal('modal-add-note', 'Add/Edit Note', `<form onsubmit="App.handleAddNote(event)"><input type="hidden" name="pId" value="${pId}"><div class="form-group"><label>Note for ${getProduct(p.productId)?.name}</label><textarea name="note" class="form-control" required>${p.notes || ''}</textarea></div><button type="submit" class="btn btn-primary btn-block">Save Note</button></form>`).classList.add('active'); };
            window.showProductionLogModal = () => { let content = state.productionLog.length === 0 ? '<div class="empty-state">No completed runs.</div>' : `<div>${[...state.productionLog].reverse().map(p => { const pr = getProduct(p.productId), c = getCompany(pr?.companyId); return `<div class="card"><div class="card-header">${pr?.name || '...'}</div><div class="card-body"><p><strong>Company:</strong> ${c?.name || '...'}</p><p><strong>Qty Produced:</strong> ${p.totalQty}</p><p><strong>Completed:</strong> ${new Date(p.completionDate).toLocaleString()}</p></div></div>` }).join('')}</div>`; createModal('modal-production-log', 'Completed Production Log', content).classList.add('active'); };
            window.showDispatchModal = () => {
                const grouped = state.inventory.reduce((acc, item) => { if (item.qty <= 0) return acc; const product = getProduct(item.productId); const company = getCompany(product?.companyId); if (!acc[company.id]) acc[company.id] = { companyName: company.name, items: [] }; if (!acc[company.id].items.find(i => i.productId === item.productId)) { acc[company.id].items.push({ productId: item.productId, name: product.name, qty: 0 }); } acc[company.id].items.find(i => i.productId === item.productId).qty += item.qty; return acc; }, {});
                let listContent = Object.values(grouped).map(group => `<div class="date-header">${group.companyName}</div>` + group.items.map(item => `<div class="dispatch-item card" data-product-id="${item.productId}"><p><strong>${item.name}</strong> (Available: ${item.qty})</p><div class="form-group" style="margin-bottom:0;"><input type="number" class="form-control" min="0" max="${item.qty}" placeholder="Dispatch Qty"></div></div>`).join('')).join('');
                if (!listContent) listContent = '<div class="empty-state">No items in inventory to dispatch.</div>';
                const content = `<form onsubmit="App.handleDispatch(event)"><div class="form-group"><label for="party-name">Recipient / Party Name</label><input type="text" name="partyName" class="form-control" required placeholder="e.g., Amazon Warehouse"></div><hr style="margin:20px 0;border:0;border-top:1px solid var(--border-color);">${listContent}<button type="submit" class="btn btn-success btn-block" style="margin-top:20px;" ${!Object.keys(grouped).length ? 'disabled' : ''}>Complete and Log Dispatch</button></form>`;
                createModal('modal-add-dispatch', 'Create New Dispatch', content).classList.add('active');
            };
            window.hideModal = (id) => { const modal = document.getElementById(id); if(modal) modal.remove(); };

            const handleProductForm = e => { e.preventDefault(); const f = e.target; const coName = f.querySelector('#product-company').value.trim(); const pName = f.querySelector('#product-name').value.trim(); let co = state.companies.find(c => c.name.toLowerCase() === coName.toLowerCase()); if (!co) { co = { id: `co_${Date.now()}`, name: coName }; state.companies.push(co); } let p = state.products.find(pr => pr.name.toLowerCase() === pName.toLowerCase() && pr.companyId === co.id); if (!p) { p = { id: `p_${Date.now()}`, name: pName, companyId: co.id, dimensions: f.querySelector('#product-dimensions').value.trim() }; state.products.push(p); } const machines = Array.from(f.querySelectorAll('input[name="machines"]:checked')).map(cb => cb.value); if(machines.length === 0) return alert('Please select at least one machine.'); state.production.push({ productionId: `run_${Date.now()}`, productId: p.id, totalQty: parseInt(f.querySelector('#product-qty').value), machinesInvolved: machines, machineSteps: machines.map(m => ({ machine: m, qtyDone: 0, status: 'Pending' })), qtyMovedToInventory: 0, dateAdded: new Date().toISOString() }); saveState(); renderAllViews(); hideModal('modal-add-product'); showView('production'); };
            const handleProgressUpdate = e => { e.preventDefault(); const data = new FormData(e.target); const p = state.production.find(pr => pr.productionId === data.get('pId')); const s = p.machineSteps.find(st => st.machine === data.get('mName')); const qty = parseInt(data.get('qty')); if (qty > 0 && (s.qtyDone + qty) <= p.totalQty) { s.qtyDone += qty; if (s.qtyDone >= p.totalQty) { s.qtyDone = p.totalQty; s.status = 'Completed'; s.timestamp = new Date().toISOString(); } } else { return alert(`Invalid quantity.`); } saveState(); renderAllViews(); hideModal('modal-update-progress'); };
            const moveCompletedToInventory = pId => { const pIndex = state.production.findIndex(pr => pr.productionId === pId); if (pIndex === -1) return; const p = state.production[pIndex]; const transferableQty = Math.min(...p.machineSteps.map(s => s.qtyDone)) - p.qtyMovedToInventory; if (transferableQty <= 0) return alert('No new units to move.'); if (!confirm(`Move ${transferableQty} units of ${getProduct(p.productId).name} to inventory?`)) return; state.inventory.push({ inventoryId: `inv_${Date.now()}`, productId: p.productId, qty: transferableQty, sourceProductionId: pId }); p.qtyMovedToInventory += transferableQty; if (p.qtyMovedToInventory >= p.totalQty) { p.completionDate = new Date().toISOString(); state.productionLog.push(p); state.production.splice(pIndex, 1); alert(`${transferableQty} units moved. Production run complete and moved to log.`); } else { alert(`${transferableQty} units moved successfully.`); } saveState(); renderAllViews(); };
            const handleDispatch = e => { e.preventDefault(); const form = e.target; const partyName = form.querySelector('[name=partyName]').value.trim(); const items = []; form.querySelectorAll('.dispatch-item').forEach(el => { const qty = parseInt(el.querySelector('input').value || '0'); if (qty > 0) items.push({ productId: el.dataset.productId, qty }); }); if (items.length === 0) return alert("Enter a quantity for at least one product."); items.forEach(item => { let qtyToReduce = item.qty; state.inventory.filter(inv => inv.productId === item.productId).forEach(entry => { if (qtyToReduce === 0) return; const reduction = Math.min(entry.qty, qtyToReduce); entry.qty -= reduction; qtyToReduce -= reduction; }); }); state.inventory = state.inventory.filter(i => i.qty > 0); state.dispatches.push({ dispatchId: `d_${Date.now()}`, partyName, items, date: new Date().toISOString() }); saveState(); exportData(true); renderAllViews(); hideModal('modal-add-dispatch'); };
            const handleAddNote = e => { e.preventDefault(); const data = new FormData(e.target); const p = state.production.find(pr => pr.productionId === data.get('pId')); if (p) p.notes = data.get('note').trim(); saveState(); renderFunctions.production(); hideModal('modal-add-note'); };

            const getProduct = pId => state.products.find(p => p.id === pId);
            const getCompany = cId => state.companies.find(c => c.id === cId);
            const handleAutocomplete = (el, key, prop, cb) => { const listEl = el.nextElementSibling, val = el.value.toLowerCase(); listEl.innerHTML = ''; if (!val) return; const sugg = state[key].filter(i => i[prop].toLowerCase().includes(val)).slice(0, 5); sugg.forEach(i => { const d = document.createElement('div'); d.className = 'autocomplete-item'; d.textContent = i[prop]; d.onclick = () => { el.value = i[prop]; listEl.innerHTML = ''; if (el.id === 'product-name') document.getElementById('product-dimensions').value = i.dimensions || ''; if (cb) cb(i); }; listEl.appendChild(d); }); if (!sugg.some(i => i[prop].toLowerCase() === val)) { const d = document.createElement('div'); d.className = 'autocomplete-item add-new'; d.textContent = `+ Add "${el.value}"`; d.onclick = () => { listEl.innerHTML = ''; if (cb) cb({id: null, [prop]: el.value}); }; listEl.appendChild(d); } };
            const exportData = (isAuto = false) => { try { saveAs(new Blob([JSON.stringify(state, null, 2)], {type: "application/json;charset=utf-8"}), `supervisor_data_${new Date().toISOString().split('T')[0]}.json`); if(!isAuto) alert('Data backup download initiated.'); } catch(e) { alert("Error exporting data."); } };
            const importData = e => { const f = e.target.files[0]; if (!f || !confirm("This will OVERWRITE all data. Are you sure?")) return e.target.value = null; const r = new FileReader(); r.onload = (ev) => { try { const imp = JSON.parse(ev.target.result); if (imp.companies && imp.products) { state = { companies: [], products: [], production: [], inventory: [], dispatches: [], productionLog: [], ...imp }; saveState(); renderAllViews(); showView('dashboard'); alert('Data imported successfully!'); } else alert('Import failed: Invalid file format.'); } catch (err) { alert('Import failed: Could not read file.'); } finally { e.target.value = null; } }; r.readAsText(f); };

            return { init, showView, handleProductForm, handleProgressUpdate, moveCompletedToInventory, handleDispatch, exportData, importData, handleAddNote, handleAutocomplete };
        })();
        document.addEventListener('DOMContentLoaded', App.init);
    </script>
</body>
</html>